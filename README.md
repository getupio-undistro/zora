# Snitch

Snitch denounces potential issues in your Kubernetes cluster
and provides a multi cluster visibility.

- [Install](#install)
- [Usage](#usage)
    + [Connect a cluster](#connect-a-cluster)
        - [Generate a kubeconfig file](#generate-a-kubeconfig-file)
        - [Create a secret with your kubeconfig](#create-a-secret-with-your-kubeconfig)
        - [Create a Cluster resource](#create-a-cluster-resource)
- [Uninstall](#uninstall)
- [Glossary](#glossary)

## Install

1. Create a namespace `snitch` for Snitch components:
```shell
kubectl create namespace snitch
```

2. Install Snitch using [Helm](https://helm.sh/docs/):
```shell
helm repo add snitch https://registry.undistro.io/chartrepo/snitch
helm install snitch snitch/snitch -n snitch
```

These commands deploy Snitch on the Kubernetes cluster in the default configuration. 
[This section](#TODO) lists the parameters that can be configured during installation.

## Usage

### Connect a cluster

To connect a cluster, you must have a kubeconfig file with a `token` and
the management cluster must be able to reach the api-server of target cluster.

If you already have a kubeconfig, 
skip the next step and go to [Create a secret with your kubeconfig](#create-a-secret-with-your-kubeconfig) section. 

#### Generate a kubeconfig file

The kubeconfig files generated by cloud providers
have CLI commands, such as `aws` or `gcloud`, to obtain an authentication token.

Snitch just needs a token that can be obtained creating a new service account.

1. Create the service account with `view` permissions:
```shell
kubectl -n kube-system create serviceaccount snitch-view
kubectl create clusterrolebinding snitch-view --clusterrole=view --serviceaccount=kube-system:snitch-view
```

2. Set up the following environment variables:
```shell
export TOKEN_NAME=$(kubectl -n kube-system get serviceaccount snitch-view -o=jsonpath='{.secrets[0].name}')
export TOKEN_VALUE=$(kubectl -n kube-system get secret/${TOKEN_NAME} -o=jsonpath='{.data.token}' | base64 --decode)
export CURRENT_CONTEXT=$(kubectl config current-context)
export CURRENT_CLUSTER=$(kubectl config view --raw -o=go-template='{{range .contexts}}{{if eq .name "'''${CURRENT_CONTEXT}'''"}}{{ index .context "cluster" }}{{end}}{{end}}')
export CLUSTER_CA=$(kubectl config view --raw -o=go-template='{{range .clusters}}{{if eq .name "'''${CURRENT_CLUSTER}'''"}}"{{with index .cluster "certificate-authority-data" }}{{.}}{{end}}"{{ end }}{{ end }}')
export CLUSTER_SERVER=$(kubectl config view --raw -o=go-template='{{range .clusters}}{{if eq .name "'''${CURRENT_CLUSTER}'''"}}{{ .cluster.server }}{{end}}{{ end }}')
```

3. Generate a kubeconfig file:
```shell
cat << EOF > snitch-view-kubeconfig.yml
apiVersion: v1
kind: Config
current-context: ${CURRENT_CONTEXT}
contexts:
- name: ${CURRENT_CONTEXT}
  context:
    cluster: ${CURRENT_CONTEXT}
    user: snitch-view
    namespace: kube-system
clusters:
- name: ${CURRENT_CONTEXT}
  cluster:
    certificate-authority-data: ${CLUSTER_CA}
    server: ${CLUSTER_SERVER}
users:
- name: snitch-view
  user:
    token: ${TOKEN_VALUE}
EOF
```

#### Create a secret with your kubeconfig

```shell
kubectl create secret generic mycluster-kubeconfig \
  --from-file=value=snitch-view-kubeconfig.yml
```

#### Create a Cluster resource

```shell
cat << EOF | kubectl apply -f -
apiVersion: snitch.undistro.io/v1alpha1
kind: Cluster
metadata:
  name: mycluster
spec:
  kubeconfigRef:
    name: mycluster-kubeconfig

EOF
```

## Uninstall

```shell
helm delete snitch -n snitch
kubectl delete namespace snitch
```

## Glossary

- **Management Cluster**: The only Kubernetes cluster where Snitch is installed.
